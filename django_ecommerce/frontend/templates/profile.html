{% extends 'base.html' %}

{% block title %}My Profile - E-Commerce Store{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <!-- Profile Sidebar -->
        <div class="col-lg-3">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <img src="" alt="Profile Picture" class="rounded-circle mb-3" id="profilePicture" style="width: 150px; height: 150px; object-fit: cover;">
                    <h5 class="mb-1" id="userName"></h5>
                    <p class="text-muted mb-3" id="userEmail"></p>
                    <button class="btn btn-primary btn-sm" onclick="document.getElementById('profilePictureInput').click()">
                        Change Picture
                    </button>
                    <input type="file" id="profilePictureInput" accept="image/*" style="display: none;" onchange="updateProfilePicture(this)">
                </div>
            </div>

            <!-- Navigation Menu -->
            <div class="card mb-4">
                <div class="list-group list-group-flush">
                    <button class="list-group-item list-group-item-action active" onclick="showSection('profile')">
                        <i class="fas fa-user me-2"></i>Profile Information
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="showSection('orders')">
                        <i class="fas fa-shopping-bag me-2"></i>Order History
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="showSection('addresses')">
                        <i class="fas fa-map-marker-alt me-2"></i>Addresses
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="showSection('payment')">
                        <i class="fas fa-credit-card me-2"></i>Payment Methods
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="showSection('security')">
                        <i class="fas fa-lock me-2"></i>Security
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- Profile Information Section -->
            <div id="profileSection" class="content-section active">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Profile Information</h5>
                    </div>
                    <div class="card-body">
                        <form id="profileForm" class="needs-validation" novalidate>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="firstName" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="firstName" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="lastName" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="lastName" required>
                                </div>
                                <div class="col-12">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="col-12">
                                    <label for="phone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone">
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Order History Section -->
            <div id="ordersSection" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Order History</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Order #</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Total</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="orderHistory"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Addresses Section -->
            <div id="addressesSection" class="content-section">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Addresses</h5>
                        <button class="btn btn-primary btn-sm" onclick="showAddAddressForm()">
                            <i class="fas fa-plus me-1"></i>Add Address
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="addressList" class="row"></div>
                        
                        <!-- Add Address Form -->
                        <div id="addAddressForm" style="display: none;">
                            <h6 class="mb-3">Add New Address</h6>
                            <form id="addressForm" class="needs-validation" novalidate>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="addressLine" class="form-label">Address</label>
                                        <input type="text" class="form-control" id="addressLine" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="addressCity" class="form-label">City</label>
                                        <input type="text" class="form-control" id="addressCity" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="addressState" class="form-label">State</label>
                                        <select class="form-select" id="addressState" required>
                                            <option value="">Choose...</option>
                                            <!-- States will be populated via JavaScript -->
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="addressZip" class="form-label">ZIP</label>
                                        <input type="text" class="form-control" id="addressZip" required>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="defaultAddress">
                                            <label class="form-check-label" for="defaultAddress">
                                                Set as default address
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">Save Address</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="hideAddAddressForm()">Cancel</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Methods Section -->
            <div id="paymentSection" class="content-section">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Payment Methods</h5>
                        <button class="btn btn-primary btn-sm" onclick="showAddPaymentForm()">
                            <i class="fas fa-plus me-1"></i>Add Payment Method
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="paymentList" class="row"></div>
                        
                        <!-- Add Payment Form -->
                        <div id="addPaymentForm" style="display: none;">
                            <h6 class="mb-3">Add New Payment Method</h6>
                            <form id="paymentForm" class="needs-validation" novalidate>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="cardName" class="form-label">Name on Card</label>
                                        <input type="text" class="form-control" id="cardName" required>
                                    </div>
                                    <div class="col-12">
                                        <label for="cardNumber" class="form-label">Card Number</label>
                                        <input type="text" class="form-control" id="cardNumber" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="expMonth" class="form-label">Month</label>
                                        <select class="form-select" id="expMonth" required>
                                            <option value="">MM</option>
                                            <!-- Months will be populated via JavaScript -->
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="expYear" class="form-label">Year</label>
                                        <select class="form-select" id="expYear" required>
                                            <option value="">YYYY</option>
                                            <!-- Years will be populated via JavaScript -->
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="cvv" class="form-label">CVV</label>
                                        <input type="text" class="form-control" id="cvv" required>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="defaultPayment">
                                            <label class="form-check-label" for="defaultPayment">
                                                Set as default payment method
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">Save Payment Method</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="hideAddPaymentForm()">Cancel</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Section -->
            <div id="securitySection" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Security Settings</h5>
                    </div>
                    <div class="card-body">
                        <!-- Change Password Form -->
                        <form id="passwordForm" class="needs-validation" novalidate>
                            <h6 class="mb-3">Change Password</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="currentPassword" class="form-label">Current Password</label>
                                    <input type="password" class="form-control" id="currentPassword" required>
                                </div>
                                <div class="col-12">
                                    <label for="newPassword" class="form-label">New Password</label>
                                    <input type="password" class="form-control" id="newPassword" required>
                                </div>
                                <div class="col-12">
                                    <label for="confirmPassword" class="form-label">Confirm New Password</label>
                                    <input type="password" class="form-control" id="confirmPassword" required>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">Change Password</button>
                                </div>
                            </div>
                        </form>

                        <hr class="my-4">

                        <!-- Two-Factor Authentication -->
                        <h6 class="mb-3">Two-Factor Authentication</h6>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="twoFactorAuth" onchange="toggleTwoFactor(this)">
                            <label class="form-check-label" for="twoFactorAuth">
                                Enable two-factor authentication
                            </label>
                        </div>
                        <p class="text-muted small mt-2">
                            Two-factor authentication adds an extra layer of security to your account by requiring more than just a password to log in.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Load user data
    loadUserProfile();
    
    // Load states for address form
    populateStates();
    
    // Load card expiration dates
    populateExpDates();
    
    // Set up form validation
    setupFormValidation();
});

async function loadUserProfile() {
    try {
        const response = await fetch(`${API_BASE_URL}/users/profile`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load profile');
        }
        
        const user = await response.json();
        displayUserProfile(user);
        loadOrderHistory();
        loadAddresses();
        loadPaymentMethods();
    } catch (error) {
        showToast(error.message, 'error');
    }
}

function displayUserProfile(user) {
    // Profile picture
    document.getElementById('profilePicture').src = user.profile_picture || '/static/images/default-profile.png';
    
    // User info
    document.getElementById('userName').textContent = `${user.first_name} ${user.last_name}`;
    document.getElementById('userEmail').textContent = user.email;
    
    // Form fields
    document.getElementById('firstName').value = user.first_name;
    document.getElementById('lastName').value = user.last_name;
    document.getElementById('email').value = user.email;
    document.getElementById('phone').value = user.phone || '';
}

async function loadOrderHistory() {
    try {
        const response = await fetch(`${API_BASE_URL}/orders/`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load orders');
        }
        
        const orders = await response.json();
        displayOrders(orders);
    } catch (error) {
        showToast(error.message, 'error');
    }
}

function displayOrders(orders) {
    const container = document.getElementById('orderHistory');
    container.innerHTML = '';
    
    orders.forEach(order => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>#${order.id}</td>
            <td>${new Date(order.created_at).toLocaleDateString()}</td>
            <td><span class="badge bg-${getStatusBadgeColor(order.status)}">${order.status}</span></td>
            <td>$${order.total.toFixed(2)}</td>
            <td>
                <a href="/orders/${order.id}" class="btn btn-sm btn-outline-primary">View</a>
            </td>
        `;
        container.appendChild(row);
    });
}

function getStatusBadgeColor(status) {
    switch (status.toLowerCase()) {
        case 'delivered':
            return 'success';
        case 'shipped':
            return 'info';
        case 'processing':
            return 'warning';
        case 'cancelled':
            return 'danger';
        default:
            return 'secondary';
    }
}

async function loadAddresses() {
    try {
        const response = await fetch(`${API_BASE_URL}/users/addresses`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load addresses');
        }
        
        const addresses = await response.json();
        displayAddresses(addresses);
    } catch (error) {
        showToast(error.message, 'error');
    }
}

function displayAddresses(addresses) {
    const container = document.getElementById('addressList');
    container.innerHTML = '';
    
    addresses.forEach(address => {
        const col = document.createElement('div');
        col.className = 'col-md-6 mb-3';
        col.innerHTML = `
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title">
                        ${address.is_default ? '<span class="badge bg-primary me-2">Default</span>' : ''}
                        ${address.name || 'Address'}
                    </h6>
                    <p class="card-text">
                        ${address.street}<br>
                        ${address.city}, ${address.state} ${address.zip}
                    </p>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" onclick="editAddress(${address.id})">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAddress(${address.id})">Delete</button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(col);
    });
}

async function loadPaymentMethods() {
    try {
        const response = await fetch(`${API_BASE_URL}/users/payment-methods`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load payment methods');
        }
        
        const paymentMethods = await response.json();
        displayPaymentMethods(paymentMethods);
    } catch (error) {
        showToast(error.message, 'error');
    }
}

function displayPaymentMethods(paymentMethods) {
    const container = document.getElementById('paymentList');
    container.innerHTML = '';
    
    paymentMethods.forEach(method => {
        const col = document.createElement('div');
        col.className = 'col-md-6 mb-3';
        col.innerHTML = `
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title">
                        ${method.is_default ? '<span class="badge bg-primary me-2">Default</span>' : ''}
                        ${method.card_type}
                    </h6>
                    <p class="card-text">
                        **** **** **** ${method.last4}<br>
                        Expires: ${method.exp_month}/${method.exp_year}
                    </p>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" onclick="editPaymentMethod(${method.id})">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePaymentMethod(${method.id})">Delete</button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(col);
    });
}

function showSection(section) {
    // Update active nav item
    document.querySelectorAll('.list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // Show selected section
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    document.getElementById(`${section}Section`).classList.add('active');
}

function setupFormValidation() {
    const forms = document.querySelectorAll('.needs-validation');
    
    forms.forEach(form => {
        form.addEventListener('submit', async event => {
            event.preventDefault();
            
            if (form.checkValidity()) {
                if (form.id === 'profileForm') {
                    await updateProfile();
                } else if (form.id === 'addressForm') {
                    await saveAddress();
                } else if (form.id === 'paymentForm') {
                    await savePaymentMethod();
                } else if (form.id === 'passwordForm') {
                    await changePassword();
                }
            }
            
            form.classList.add('was-validated');
        });
    });
}

async function updateProfile() {
    try {
        const response = await fetch(`${API_BASE_URL}/users/profile`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
                first_name: document.getElementById('firstName').value,
                last_name: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to update profile');
        }
        
        showToast('Profile updated successfully', 'success');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function updateProfilePicture(input) {
    if (input.files && input.files[0]) {
        const formData = new FormData();
        formData.append('profile_picture', input.files[0]);
        
        try {
            const response = await fetch(`${API_BASE_URL}/users/profile-picture`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Failed to update profile picture');
            }
            
            const data = await response.json();
            document.getElementById('profilePicture').src = data.profile_picture_url;
            showToast('Profile picture updated successfully', 'success');
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
}

function showAddAddressForm() {
    document.getElementById('addAddressForm').style.display = 'block';
}

function hideAddAddressForm() {
    document.getElementById('addAddressForm').style.display = 'none';
    document.getElementById('addressForm').reset();
}

function showAddPaymentForm() {
    document.getElementById('addPaymentForm').style.display = 'block';
}

function hideAddPaymentForm() {
    document.getElementById('addPaymentForm').style.display = 'none';
    document.getElementById('paymentForm').reset();
}

async function saveAddress() {
    try {
        const response = await fetch(`${API_BASE_URL}/users/addresses`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
                street: document.getElementById('addressLine').value,
                city: document.getElementById('addressCity').value,
                state: document.getElementById('addressState').value,
                zip: document.getElementById('addressZip').value,
                is_default: document.getElementById('defaultAddress').checked
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to save address');
        }
        
        hideAddAddressForm();
        loadAddresses();
        showToast('Address saved successfully', 'success');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function savePaymentMethod() {
    try {
        const response = await fetch(`${API_BASE_URL}/users/payment-methods`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
                card_name: document.getElementById('cardName').value,
                card_number: document.getElementById('cardNumber').value,
                exp_month: document.getElementById('expMonth').value,
                exp_year: document.getElementById('expYear').value,
                cvv: document.getElementById('cvv').value,
                is_default: document.getElementById('defaultPayment').checked
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to save payment method');
        }
        
        hideAddPaymentForm();
        loadPaymentMethods();
        showToast('Payment method saved successfully', 'success');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function changePassword() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        showToast('Passwords do not match', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/users/change-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
                current_password: document.getElementById('currentPassword').value,
                new_password: newPassword
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to change password');
        }
        
        document.getElementById('passwordForm').reset();
        showToast('Password changed successfully', 'success');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function toggleTwoFactor(checkbox) {
    try {
        const response = await fetch(`${API_BASE_URL}/users/two-factor`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
                enabled: checkbox.checked
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to update two-factor authentication');
            checkbox.checked = !checkbox.checked;
        }
        
        showToast(`Two-factor authentication ${checkbox.checked ? 'enabled' : 'disabled'}`, 'success');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

function populateStates() {
    const states = [
        'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA',
        'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
        'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
        'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
        'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'
    ];
    
    const select = document.getElementById('addressState');
    states.forEach(state => {
        const option = document.createElement('option');
        option.value = state;
        option.textContent = state;
        select.appendChild(option);
    });
}

function populateExpDates() {
    const monthSelect = document.getElementById('expMonth');
    const yearSelect = document.getElementById('expYear');
    
    // Populate months
    for (let i = 1; i <= 12; i++) {
        const month = i.toString().padStart(2, '0');
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month;
        monthSelect.appendChild(option);
    }
    
    // Populate years
    const currentYear = new Date().getFullYear();
    for (let i = 0; i < 10; i++) {
        const year = currentYear + i;
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    }
}
</script>

<style>
.content-section {
    display: none;
}

.content-section.active {
    display: block;
}

.tracking-timeline {
    position: relative;
    padding: 0;
}

.tracking-step {
    display: flex;
    align-items: flex-start;
    padding-bottom: 1.5rem;
    position: relative;
}

.tracking-step:not(:last-child)::before {
    content: '';
    position: absolute;
    left: 1.25rem;
    top: 2.5rem;
    bottom: 0;
    width: 2px;
    background-color: #e9ecef;
}

.tracking-step.completed:not(:last-child)::before {
    background-color: #198754;
}

.tracking-icon {
    width: 2.5rem;
    height: 2.5rem;
    background-color: #e9ecef;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
}

.tracking-step.completed .tracking-icon {
    background-color: #198754;
    color: white;
}

.tracking-content {
    flex: 1;
}
</style>
{% endblock %} 